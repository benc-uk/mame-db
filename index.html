<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MAME 2003 DB</title>

    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fast-xml-parser/4.0.13/fxparser.js"></script>

    <link rel="stylesheet" href="main.css" />
    <link rel="stylesheet" href="spinner.css" />
    <link rel="shortcut icon" href="img/icon.png" type="image/png" />
  </head>
  <body>
    <script>
      const dataFile = 'data/mame.xml'
      const pageSize = 150

      async function loadData() {
        console.log('Loading data...')

        const dataResp = await fetch(dataFile)
        if (!dataResp.ok) {
          throw new Error(`Failed to load ${dataFile}: ${dataResp.status}`)
        }
        const xmlContent = await dataResp.text()
        const parser = new fxparser.XMLParser({ ignoreAttributes: false })
        const rawData = parser.parse(xmlContent)

        console.log(`Loaded ${rawData.mame.game.length} games`)

        const sortedGames = rawData.mame.game.sort((a, b) => {
          const aName = a.description
          const bName = b.description
          if (aName < bName) {
            return -1
          }
          if (aName > bName) {
            return 1
          }
          return 0
        })

        return sortedGames
      }

      Alpine.data('gameComponent', () => ({
        games: [],
        err: null,
        filterRom: '',
        filterManu: '',
        filterDesc: '',
        filterClones: false,
        filteredGames: [],
        page: 0,
        pageCount: 0,
        filterCount: 0,

        init: async function () {
          try {
            this.games = await loadData()
          } catch (e) {
            this.err = e
          }

          this.$watch('page', () => {
            this.runFilter()
          })

          this.runFilter()
        },

        runFilter: function () {
          const filtResult = this.games.filter((g) => {
            if (
              g['@_name'].startsWith(this.filterRom) &&
              g.manufacturer.toLowerCase().includes(this.filterManu) &&
              g.description.toString().toLowerCase().includes(this.filterDesc) &&
              (!this.filterClones || !g['@_cloneof'])
            ) {
              return true
            }

            return false
          })

          this.filterCount = filtResult.length
          this.filteredGames = filtResult.slice(this.page * pageSize, (this.page + 1) * pageSize)
          this.pageCount = Math.ceil(this.filterCount / pageSize)
        },
      }))
    </script>

    <h1><img src="img/icon.png" />MAME 2003 Reference Database</h1>
    <div x-data="gameComponent">
      <div x-show="err" class="guru">
        Software Failure.<br />
        Guru Meditation <span x-text="err"></span>
      </div>

      <div x-show="games.length <= 0 && !err">
        <h2 class="centerText">Loading database, please wait...</h2>
        <div id="loading"></div>
      </div>

      <div x-show="games.length > 0 && !err">
        <label for="filter-desc">Title:</label>
        <input
          type="text"
          autocomplete="off"
          placeholder="Title"
          x-model="filterDesc"
          id="filter-desc"
          @input.debounce="page = 0; runFilter()"
          @keyup="filterDesc = $event.target.value.toLowerCase()"
        />
        <label for="filter-rom">ROM Name:</label>
        <input
          type="text"
          autocomplete="off"
          placeholder="ROM Name"
          x-model="filterRom"
          id="filter-rom"
          @input.debounce="page = 0; runFilter()"
          @keyup="filterRom = $event.target.value.toLowerCase()"
        />
        <label for="filter-manu">Manufacturer:</label>
        <input
          type="text"
          autocomplete="off"
          placeholder="Manufacturer"
          x-model="filterManu"
          id="filter-manu"
          @input.debounce="page = 0; runFilter()"
          @keyup="filterManu = $event.target.value.toLowerCase()"
        />
        <label for="filter-clones">Hide Clones:</label>
        <input type="checkbox" x-model="filterClones" id="filter-clones" @change="runFilter()" />
      </div>

      <div x-show="filterCount > 0 && !err" class="pages">
        Games: <span x-text="filterCount" class="gameCount"></span>

        Pages:
        <template x-for="i in pageCount" :key="i">
          <button x-on:click="page = i - 1" x-text="i" :class="page == i-1 ? 'active' : ''"></button>
        </template>
      </div>

      <template x-for="g in filteredGames">
        <div class="game">
          <h2 x-text="g.description"></h2>

          <div class="images">
            <img :src="`img/titles/${g['@_name']}.png`" onerror="this.src='img/no-image.png'" />
            <img :src="'img/snap/' + g['@_name'] + '.png'" onerror="this.src='img/no-image.png'" />
          </div>

          <div class="details">
            <ul>
              <li>ROM Name: <span x-text="g['@_name']"></span></li>
              <li x-show="g['@_cloneof']">Clone Of: <span x-text="g['@_cloneof']"></span></li>
              <li>Driver Status: <span x-text="g.driver && g.driver[1] ? g.driver[1]['@_status'] : 'unknown'"></span></li>
              <li>Year: <span x-text="g.year"></span></li>
              <li>Manufacturer: <span x-text="g.manufacturer"></span></li>
            </ul>
          </div>
        </div>
      </template>
    </div>
  </body>
</html>
